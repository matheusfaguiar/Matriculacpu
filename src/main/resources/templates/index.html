<!-- src/main/resources/templates/index.html -->
<div th:fragment="content" class="container mt-3 mt-md-5 fade-in-up">

  <!-- Cabe√ßalho -->
  <div th:if="${usuarioLogado == null}" id="login-section" class="text-center mb-4 mb-md-5">
    <h1 class="text-primary mb-3 h4 h2-md"><i class="fas fa-graduation-cap me-2"></i>Cursos da Funda√ß√£o Par√°Paz nas Usinas</h1>
    <p class="lead mb-4">
      Para realizar sua inscri√ß√£o em um dos cursos abaixo, fa√ßa login com sua conta Google.
    </p>
    <a href="/auth/google" class="btn btn-primary rounded-pill px-4 px-md-5 py-2 py-md-3">
      <i class="bi bi-google me-2"></i>Login com Google
    </a>
  </div>

  <div th:if="${usuarioLogado != null}" class="text-center mb-4 mb-md-5">
    <h1 class="text-primary mb-3 h4 h2-md"><i class="fas fa-graduation-cap me-2"></i>Cursos da Funda√ß√£o Par√°Paz nas Usinas</h1>
    <p class="lead text-success mb-0">
      Bem-vindo, <b th:text="${usuarioLogado.nomeExibicao}"></b>!
    </p>
  </div>

  <hr class="mb-4 mb-md-5"/>

  <!-- Conte√∫do apenas quando h√° cursos -->
  <div th:if="${cursos != null and not cursos.empty}">
    <!-- Filtro de Local -->
    <div class="row mb-4">
      <div class="col-12 col-md-6">
        <label for="filtroLocal" class="form-label fw-bold"><i class="fas fa-filter me-2"></i>Filtrar por Localidade:</label>
        <select id="filtroLocal" class="form-select filtro-local">
          <option value="">Todas as localidades</option>
          <option th:each="lotacao : ${lotacoes}"
                  th:value="${lotacao.nome}"
                  th:text="${lotacao.nome}">
          </option>
        </select>
      </div>
    </div>

    <!-- T√≠tulo da Se√ß√£o de Cursos -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="h5 h4-md mb-0"><i class="fas fa-book me-2"></i>Cursos Dispon√≠veis</h3>
    </div>

    <!-- Vers√£o Desktop (Table) -->
    <div class="d-none d-md-block">
      <div class="table-responsive">
        <table id="tabelaCursos" class="datatable display table table-striped table-hover align-middle" style="width:100%">
          <thead class="table-primary">
            <tr>
              <th><i class="fas fa-bookmark me-2"></i>Nome</th>
              <th><i class="fas fa-map-marker-alt me-2"></i>Local</th>
              <th><i class="fas fa-users me-2"></i>Vagas</th>
              <th><i class="fas fa-clock me-2"></i>Hor√°rio</th>
              <th><i class="fas fa-calendar-alt me-2"></i>Data In√≠cio</th>
              <th><i class="fas fa-calendar-times me-2"></i>Data Fim</th>
              <th th:if="${usuarioLogado != null}" width="150"><i class="fas fa-cogs me-2"></i>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="curso : ${cursos}">
              <td th:text="${curso.nomeExibicao}" class="fw-bold text-primary"></td>
              <td th:text="${curso.lotacao.nome}"></td>
              <td>
                <span th:classappend="${curso.vagas == 0} ? 'badge bg-danger' : 'badge bg-success'" class="badge">
                  <i class="fas fa-user-friends me-1"></i>
                  <span th:text="${curso.vagas}"></span>
                </span>
              </td>
              <td th:text="${curso.horario}"></td>
              <td th:text="${#temporals.format(curso.dataInicio, 'dd/MM/yyyy')}"></td>
              <td th:text="${#temporals.format(curso.dataFim, 'dd/MM/yyyy')}"></td>
              
              <!-- Coluna de A√ß√µes - Desktop -->
              <td th:if="${usuarioLogado != null}">
                <div class="btn-group btn-group-sm" role="group">
                  <!-- Bot√£o Inscrever-se (apenas se n√£o tem matr√≠cula) -->
                  <a th:if="${matriculaPorCurso == null or !matriculaPorCurso.containsKey(curso.id)}"
                     th:href="@{/matricula/nova(cursoId=${curso.id})}" 
                     class="btn btn-success"
                     title="Inscrever-se no curso">
                    <i class="fas fa-user-plus me-1"></i>Inscrever
                  </a>
                  
                  <!-- Bot√£o Continuar Inscri√ß√£o (se tem matr√≠cula PENDENTE) -->
                  <a th:if="${matriculaPorCurso != null and matriculaPorCurso.containsKey(curso.id) and 
                             matriculaPorCurso.get(curso.id).status == 'PENDENTE'}"
                     th:href="@{/matricula/nova(cursoId=${matriculaPorCurso.get(curso.id).curso.id})}" 
                     class="btn btn-warning"
                     title="Continuar inscri√ß√£o">
                    <i class="fas fa-play-circle me-1"></i>Continuar
                  </a>
                  
                  <!-- Bot√£o Detalhes (se tem matr√≠cula com status diferente de PENDENTE) -->
                  <a th:if="${matriculaPorCurso != null and matriculaPorCurso.containsKey(curso.id) and 
                             matriculaPorCurso.get(curso.id).status != 'PENDENTE'}"
                     th:href="@{/matricula/confirmacao?matriculaId={id}(id=${matriculaPorCurso.get(curso.id).id})}" 
                     class="btn btn-info"
                     title="Ver detalhes da matr√≠cula">
                    <i class="fas fa-eye me-1"></i>Detalhes
                  </a>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Vers√£o Mobile (Cards) -->
    <div class="d-md-none">
      <div class="row g-3">
        <div th:each="curso : ${cursos}" class="col-12">
          <div class="card mobile-curso-card h-100">
            <div class="card-body">
              <h5 class="card-title text-primary mb-3" th:text="${curso.nomeExibicao}"></h5>
              
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>Local:</small>
                  <div class="fw-bold" th:text="${curso.lotacao.nome}"></div>
                </div>
                <div class="col-6">
                  <small class="text-muted"><i class="fas fa-users me-1"></i>Vagas:</small>
                  <div>
                    <span th:classappend="${curso.vagas == 0} ? 'badge bg-danger' : 'badge bg-success'" class="badge">
                      <i class="fas fa-user-friends me-1"></i>
                      <span th:text="${curso.vagas}"></span>
                    </span>
                  </div>
                </div>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <small class="text-muted"><i class="fas fa-clock me-1"></i>Hor√°rio:</small>
                  <div class="fw-bold" th:text="${curso.horario}"></div>
                </div>
                <div class="col-6">
                  <small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>In√≠cio:</small>
                  <div class="fw-bold" th:text="${#temporals.format(curso.dataInicio, 'dd/MM/yyyy')}"></div>
                </div>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-12">
                  <small class="text-muted"><i class="fas fa-calendar-times me-1"></i>T√©rmino:</small>
                  <div class="fw-bold" th:text="${#temporals.format(curso.dataFim, 'dd/MM/yyyy')}"></div>
                </div>
              </div>

              <!-- A√ß√µes - Mobile -->
              <div th:if="${usuarioLogado != null}" class="d-grid gap-2 pt-3 border-top">
                <!-- Bot√£o Inscrever-se (apenas se n√£o tem matr√≠cula) -->
                <a th:if="${matriculaPorCurso == null or !matriculaPorCurso.containsKey(curso.id)}"
                   th:href="@{/matricula/nova(cursoId=${curso.id})}" 
                   class="btn btn-success">
                  <i class="fas fa-user-plus me-2"></i>Inscrever-se
                </a>
                
                <!-- Bot√£o Continuar Inscri√ß√£o (se tem matr√≠cula PENDENTE) -->
                <a th:if="${matriculaPorCurso != null and matriculaPorCurso.containsKey(curso.id) and 
                           matriculaPorCurso.get(curso.id).status == 'PENDENTE'}"
                   th:href="@{/matricula/nova(cursoId=${matriculaPorCurso.get(curso.id).curso.id})}" 
                   class="btn btn-warning">
                  <i class="fas fa-play-circle me-2"></i>Continuar Inscri√ß√£o
                </a>
                
                <!-- Bot√£o Detalhes (se tem matr√≠cula com status diferente de PENDENTE) -->
                <a th:if="${matriculaPorCurso != null and matriculaPorCurso.containsKey(curso.id) and 
                           matriculaPorCurso.get(curso.id).status != 'PENDENTE'}"
                   th:href="@{/matricula/confirmacao?matriculaId={id}(id=${matriculaPorCurso.get(curso.id).id})}" 
                   class="btn btn-info">
                  <i class="fas fa-eye me-2"></i>Ver Detalhes
                </a>
              </div>

              <!-- Mensagem para usu√°rio n√£o logado -->
              <div th:if="${usuarioLogado == null}" class="alert alert-info mt-3 mb-0 py-2">
                <small>
                  <i class="fas fa-info-circle me-1"></i>
                  <a href="/auth/google">Fa√ßa login para se inscrever</a>
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensagem quando n√£o h√° cursos -->
  <div th:if="${cursos == null or cursos.empty}" class="text-center py-5 empty-cursos-state">
    <i class="fas fa-book fa-3x text-muted mb-3"></i>
    <h4 class="text-muted h5 h4-md">Nenhum curso dispon√≠vel...</h4>
    <p class="text-muted mb-3">No momento n√£o h√° cursos com vagas abertas.</p>
    <small class="text-muted">Volte em breve para conferir novas oportunidades!</small>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // S√≥ inicializa o filtro se houver cursos
  const filtroLocal = document.getElementById("filtroLocal");
  const linhasDesktop = document.querySelectorAll("#tabelaCursos tbody tr");
  const cardsMobile = document.querySelectorAll(".mobile-curso-card");

  if (filtroLocal) {
    // üîπ Filtro din√¢mico por localidade
    filtroLocal.addEventListener("change", function () {
      const valor = this.value.toLowerCase();
      
      // Filtro para vers√£o desktop (table)
      linhasDesktop.forEach(row => {
        const local = row.cells[1].textContent.toLowerCase();
        row.style.display = (!valor || local.includes(valor)) ? '' : 'none';
      });
      
      // Filtro para vers√£o mobile (cards)
      cardsMobile.forEach(card => {
        const localElement = card.querySelector('.card-title + .row .fw-bold');
        const local = localElement ? localElement.textContent.toLowerCase() : '';
        card.parentElement.style.display = (!valor || local.includes(valor)) ? '' : 'none';
      });
    });
  }
});
</script>