<div th:fragment="content">
    <div class="container mt-3 mt-md-4">
        <!-- Cabe√ßalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="h5 h4-md mb-0"><i class="fas fa-book me-2"></i>Cursos</h3>
            <button class="btn btn-light btn-sm" onclick="openModal('/curso/novo')">
                <i class="fas fa-plus me-1"></i>Novo Curso
            </button>
        </div>

        <!-- Aviso Mobile -->
        <div class="d-md-none alert alert-info mb-3">
            <div class="d-flex align-items-center">
                <i class="fas fa-desktop me-2"></i>
                <div>
                    <small class="fw-bold">Aviso</small>
                    <div class="small">Cadastre novos cursos pelo computador para melhor visualiza√ß√£o.</div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do apenas quando h√° cursos -->
        <div th:if="${cursos != null and not cursos.empty}">
            <!-- Contador de Cursos -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        <span th:text="${cursos.size()}"></span> cursos cadastrados
                    </div>
                </div>
            </div>

            <!-- Vers√£o Desktop (Table) -->
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table id="tabelaCursos" class="table table-striped table-hover mb-0 datatable">
                        <thead class="table-primary">
                            <tr>
                                <th><i class="fas fa-bookmark me-2"></i>Nome do Curso</th>
                                <th><i class="fas fa-map-marker-alt me-2"></i>Local</th>
                                <th><i class="fas fa-users me-2"></i>Vagas</th>
                                <th><i class="fas fa-clock me-2"></i>Hor√°rio</th>
                                <th><i class="fas fa-calendar-alt me-2"></i>Per√≠odo</th>
                                <th><i class="fas fa-cogs me-2"></i>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="curso : ${cursos}">
                                <td>
                                    <div class="fw-bold text-primary" th:text="${curso.nomeExibicao}"></div>
                                    <small class="text-muted" th:text="${curso.cargaHoraria + ' horas'}"></small>
                                </td>
                                <td th:text="${curso.lotacao.nome}"></td>
                                <td>
                                    <span th:classappend="${curso.vagas == 0} ? 'badge bg-danger' : 'badge bg-success'"
                                                            class="badge">
                                                            <i class="fas fa-user-friends me-1"></i> <span th:text="${curso.vagas}"></span>
                                    </span>
                                </td>
                                <td th:text="${curso.horario}"></td>
                                <td>
                                    <small th:text="${#temporals.format(curso.dataInicio, 'dd/MM/yy') + ' a ' + #temporals.format(curso.dataFim, 'dd/MM/yy')}"></small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        
                                        <!-- Bot√µes de A√ß√£o -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Bot√£o Editar -->
                                            <button class="btn btn-outline-primary"
                                                th:onclick="'openModal(\'' + @{/curso/editar/{id}(id=${curso.id})} + '\')'"
                                                title="Editar curso">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            
                                            <!-- Bot√£o Aprova√ß√£o de Alunos -->
                                            <a th:href="@{/curso/aprovar/{id}(id=${curso.id})}"
                                               class="btn btn-outline-warning"
                                               title="Aprovar alunos">
                                                <i class="fas fa-user-check"></i>
                                            </a>
                                            
                                            <!-- Bot√£o Gerar Certificados -->
                                            <a th:if="${usuarioLogado.perfil.id == 1}"
                                            th:href="@{/certificados/gerar-curso/{id}(id=${curso.id})}"
                                            class="btn btn-outline-info"
                                            title="Gerar certificados"
                                            onclick="return confirm('Deseja gerar certificados para todos os alunos aprovados deste curso?')">
                                            <i class="fas fa-certificate"></i>
                                        </a>
                                    </div>
                                    <!-- Indicadores Visuais (C√≠rculos) -->
                                    <div class="d-flex gap-1 me-2">
                                        <!-- Indicador de Certificados Gerados -->
                                        <span th:if="${usuarioLogado.perfil.id == 1 and curso.certificadosGerados}"
                                              class="indicator-circle bg-success"
                                              title="Certificados j√° gerados">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        

                                    </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Vers√£o Mobile (Cards) -->
            <div class="d-md-none">
                <div class="row g-3">
                    <div th:each="curso : ${cursos}" class="col-12">
                        <div class="card mobile-curso-card h-100">
                            <div class="card-body p-3">
                                <!-- Cabe√ßalho do Card com Indicadores -->
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title text-primary" th:text="${curso.nomeExibicao}"></h5>
                                    <div class="d-flex gap-1">
                                        <!-- Indicador de Certificados Gerados -->
                                        <span th:if="${usuarioLogado.perfil.id == 1 and curso.certificadosGerados}"
                                            class="indicator-circle bg-success"
                                            title="Certificados j√° gerados">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        
                                        <!-- Indicador de Vagas Esgotadas -->
                                        <span th:if="${curso.vagas == 0}"
                                            class="indicator-circle bg-danger"
                                            title="Vagas esgotadas">
                                            <i class="fas fa-users-slash"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>Local:</small>
                                        <div class="fw-bold" th:text="${curso.lotacao.nome}"></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted"><i class="fas fa-users me-1"></i>Vagas:</small>
                                        <div>
                                            <span th:classappend="${curso.vagas == 0} ? 'badge bg-danger' : 'badge bg-success'"
                                                class="badge">
                                                <span th:text="${curso.vagas}"></span> vagas
                                            </span>
                                        </div>
                                    </div>
                                </div>
            
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <small class="text-muted"><i class="fas fa-clock me-1"></i>Hor√°rio:</small>
                                        <div th:text="${curso.horario}"></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>Per√≠odo:</small>
                                        <div>
                                            <small th:text="${#temporals.format(curso.dataInicio, 'dd/MM/yy') + ' a ' + #temporals.format(curso.dataFim, 'dd/MM/yy')}"></small>
                                        </div>
                                    </div>
                                </div>
            
                                <div class="row g-2 mb-2">
                                    <div class="col-12">
                                        <small class="text-muted"><i class="fas fa-hourglass-half me-1"></i>Carga Hor√°ria:</small>
                                        <div th:text="${curso.cargaHoraria + ' horas'}"></div>
                                    </div>
                                </div>
            
                                <!-- Bot√µes de A√ß√£o -->
                                <div class="d-grid gap-2 pt-3 border-top mobile-actions">
                                    <!-- Bot√£o Editar -->
                                    <button class="btn btn-sm btn-outline-primary"
                                            th:onclick="'openModal(\'' + @{/curso/editar/{id}(id=${curso.id})} + '\')'">
                                        <i class="fas fa-edit me-2"></i>Editar
                                    </button>
            
                                    <!-- Bot√£o Aprova√ß√£o -->
                                    <a th:href="@{/curso/aprovar/{id}(id=${curso.id})}"
                                    class="btn btn-sm btn-outline-warning">
                                        <i class="fas fa-user-check me-2"></i>Aprovar Alunos
                                    </a>
            
                                    <!-- Bot√£o Certificados -->
                                    <a th:if="${usuarioLogado.perfil.id == 1}"
                                    th:href="@{/certificados/gerar-curso/{id}(id=${curso.id})}"
                                    class="btn btn-sm btn-outline-info"
                                    onclick="return confirm('Deseja gerar certificados para alunos aprovados?')">
                                        <i class="fas fa-certificate me-2"></i>Gerar Certificados
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estado Vazio -->
        <div th:if="${cursos == null or cursos.empty}" class="text-center py-5 py-md-5 empty-cursos-state">
            <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
            <h4 class="text-muted h5 h4-md">Nenhum curso cadastrado</h4>
            <p class="text-muted mb-3">Clique em "Novo Curso" para adicionar o primeiro curso.</p>
        </div>
    </div>
</div>

<!-- Script para funcionalidades -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tooltips para melhorar acessibilidade
        if (typeof bootstrap !== 'undefined') {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Confirma√ß√£o para gera√ß√£o de certificados
        const certificadoButtons = document.querySelectorAll('a[href*="/curso/gerar-certificado/"]');
        certificadoButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('Deseja gerar certificados para todos os alunos aprovados deste curso?')) {
                    e.preventDefault();
                }
            });
        });

        // Fun√ß√£o para obter o token CSRF
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="_csrf"]');
            if (meta) return meta.getAttribute('content');
            const input = document.querySelector('input[name="_csrf"]');
            return input ? input.value : null;
        }

        // üîÅ Usa delega√ß√£o de eventos para funcionar com modais carregadas via AJAX
        document.addEventListener("click", async function (ev) {
            const btn = ev.target.closest(".btnPreviewCertificado");
            if (!btn) return;

            ev.preventDefault();

            // Localiza o form dentro da modal (ou na p√°gina)
            const modal = btn.closest(".modal") || document;
            const form = modal.querySelector("form") || document.querySelector("form");

            // Pega o ID do curso
            const cursoId = form.querySelector("#cursoId")?.value || form.querySelector("#id")?.value;
            if (!cursoId) {
            toastr.warning("Salve o curso antes de gerar o preview.");
            return;
            }

            // Desabilita bot√£o e mostra spinner
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Gerando Preview...';

            // Monta o objeto do curso com os dados m√≠nimos
            // No seu script, modifique a cria√ß√£o do payload para pegar TODOS os campos:
            const payload = {
                id: parseInt(cursoId),
                nome: form.querySelector("#nome")?.value,
                cargaHoraria: parseInt(form.querySelector("#cargaHoraria")?.value || 0),
                vagas: parseInt(form.querySelector("#vagas")?.value || 0),
                dataInicio: form.querySelector("#dataInicio")?.value,
                dataFim: form.querySelector("#dataFim")?.value,
                horario: form.querySelector("#horario")?.value,
                instrutor: form.querySelector("#instrutor")?.value,
                matrizCurricular: form.querySelector("#matrizCurricular")?.value,
                tipoCurso: { 
                    id: parseInt(form.querySelector("#tipoCurso")?.value || 0) 
                },
                lotacao: { 
                    id: parseInt(form.querySelector("#lotacao")?.value || 0) 
                }
            };

            const csrfToken = getCsrfToken();

            try {
            // Faz a requisi√ß√£o para gerar o PDF
            const response = await fetch("/curso/preview-certificado", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                ...(csrfToken ? { "X-CSRF-TOKEN": csrfToken } : {})
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                toastr.error("Erro ao gerar o preview do certificado.");
                return;
            }

            // Recebe o PDF e abre em nova aba
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            // Abre em nova aba
            const newTab = window.open(url, "_blank");

            if (!newTab) {
                toastr.warning("Permita pop-ups para visualizar o certificado.");
                // fallback: for√ßa download
                const a = document.createElement("a");
                a.href = url;
                a.download = "preview_certificado.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            // Libera a URL ap√≥s 1 min
            setTimeout(() => URL.revokeObjectURL(url), 60000);

            } catch (err) {
            console.error(err);
            toastr.error("Erro inesperado ao gerar o preview.");
            } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            }
        });
    });
</script>